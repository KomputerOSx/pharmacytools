<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taper Calculator</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1050px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1 {
            margin-top: 0;
            color: #2c3e50;
        }

        /* Dropdown selector */
        .taper-selector {
            margin-bottom: 20px;
        }

        .taper-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
        }

        /* Form fields */
        .field {
            margin-bottom: 15px;
        }

        .label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #444;
        }

        .input, select.input {
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        .input:focus {
            outline: none;
            border-color: #3498db;
        }

        /* Taper input rows */
        .taper-input-row {
            display: flex;
            flex-wrap: nowrap;
            gap: 1rem;
            align-items: flex-end;
            margin-top: 10px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .taper-input-row .field {
            flex: 1 1 0;
            min-width: 0;
            margin-bottom: 0;
        }

        .delete-button-container {
            flex: 0 0 auto;
        }

        /* Buttons */
        .button {
            padding: 10px 20px;
            font-size: 14px;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }

        .button:hover {
            transform: translateY(-1px);
        }

        .button:active {
            transform: translateY(0);
        }

        .button.is-primary {
            background-color: #3498db;
            color: white;
        }

        .button.is-primary:hover {
            background-color: #2980b9;
        }

        .button.is-warning {
            background-color: #f39c12;
            color: white;
        }

        .button.is-warning:hover {
            background-color: #d68910;
        }

        .button.is-danger {
            background-color: #e74c3c;
            color: white;
        }

        .button.is-danger:hover {
            background-color: #c0392b;
        }

        .button.is-secondary {
            background-color: #95a5a6;
            color: white;
        }

        .button.is-secondary:hover {
            background-color: #7f8c8d;
        }

        /* Action buttons container */
        .action-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        /* Eye button group */
        .eye-button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .eye-button {
            padding: 10px 20px;
            font-size: 14px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .eye-button.active {
            background: #3498db;
            color: white;
        }

        .eye-button:hover:not(.active) {
            background: #ecf0f1;
        }

        /* Results */
        #taperLabel, #eyeDropLabel {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #ddd;
        }

        #taperLabel:empty, #eyeDropLabel:empty {
            display: none;
        }

        #taperLabel p, #eyeDropLabel p {
            margin: 8px 0;
            line-height: 1.6;
        }

        #taperLabel .subtitle, #eyeDropLabel .subtitle {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: #2c3e50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-body h3 {
            color: #2c3e50;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .modal-body h3:first-child {
            margin-top: 0;
        }

        .modal-body p, .modal-body li {
            color: #555;
            line-height: 1.6;
        }

        .modal-body ul {
            padding-left: 20px;
        }

        .modal-body li {
            margin-bottom: 8px;
        }

        /* Help button */
        .help-button {
            background: #3498db;
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 10px;
        }

        .help-button:hover {
            background: #2980b9;
        }

        .header-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        /* Medication options */
        .medication-options {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 6px;
            border: 1px solid #eee;
        }

        .medication-options .field {
            margin-bottom: 0;
        }

        .tablet-strengths {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            padding: 6px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .checkbox-label:hover {
            border-color: #3498db;
        }

        .checkbox-label input[type="checkbox"] {
            cursor: pointer;
        }

        .checkbox-label.checked {
            background: #e8f4f8;
            border-color: #3498db;
        }

        /* Warning banner */
        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 12px 15px;
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .warning-banner .warning-icon {
            font-size: 20px;
            line-height: 1;
            flex-shrink: 0;
        }

        .warning-banner p {
            margin: 0;
            color: #856404;
            font-size: 14px;
            line-height: 1.5;
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            background: #27ae60;
            color: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .notification .close-btn {
            margin-left: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
        }

        /* Hidden sections */
        .taper-section {
            display: none;
        }

        .taper-section.active {
            display: block;
        }

        /* Responsive */
        @media screen and (max-width: 768px) {
            .taper-input-row {
                flex-direction: column;
            }

            .taper-input-row .field {
                width: 100%;
            }

            .action-buttons-container {
                flex-direction: column;
            }

            .action-buttons-container .button {
                width: 100%;
            }

            .eye-button-group {
                flex-direction: column;
            }

            .eye-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-row">
            <h1 style="margin-bottom: 0;">Taper Calculator</h1>
            <button class="help-button" onclick="openHelpModal()" title="How to use">?</button>
        </div>

        <div class="warning-banner">
            <span class="warning-icon">&#9888;</span>
            <p><strong>Disclaimer:</strong> This is a calculation tool only. The user is solely responsible for verifying the accuracy of all information generated. Always confirm dosing instructions with appropriate clinical references before use.</p>
        </div>

        <div class="taper-selector">
            <select id="taperType" onchange="switchTaperType()">
                <option value="tablet">Tablet Taper</option>
                <option value="eyedrop">Eye Drop Taper</option>
            </select>
        </div>

        <!-- Tablet Taper Section -->
        <div id="tabletTaper" class="taper-section active">
            <div class="medication-options">
                <div class="field">
                    <label class="label">Medication</label>
                    <select class="input" id="medication-selector" onchange="changeMedication()" style="width: auto;">
                        <option value="prednisolone">Prednisolone</option>
                        <option value="dexamethasone">Dexamethasone</option>
                    </select>
                </div>
                <div class="field">
                    <label class="label">Tablet Strengths to Use</label>
                    <div class="tablet-strengths" id="tablet-strengths"></div>
                </div>
                <div class="field" style="max-width: 200px;">
                    <label class="label">Start Date (Optional)</label>
                    <input class="input" type="date" id="tablet-date-selector">
                </div>
            </div>

            <div id="tabletTaperLines"></div>

            <div class="action-buttons-container">
                <button class="button is-warning" onclick="addTabletTaperLine()">Add Taper</button>
                <button class="button is-primary" onclick="calculateTabletTaper()">Calculate</button>
                <button class="button is-secondary" onclick="copyTabletLabel()">Copy Label</button>
                <button class="button is-secondary" onclick="copyTabletDocument()">Document Copy</button>
            </div>

            <div id="taperLabel"></div>
        </div>

        <!-- Eye Drop Taper Section -->
        <div id="eyeDropTaper" class="taper-section">
            <p style="margin-bottom: 10px;"><strong>Select Eye(s)</strong></p>
            <div class="eye-button-group">
                <button class="eye-button active" onclick="selectEye('Left', this)">Left</button>
                <button class="eye-button" onclick="selectEye('Both', this)">Both</button>
                <button class="eye-button" onclick="selectEye('Right', this)">Right</button>
            </div>

            <div id="eyeDropTaperLines"></div>

            <div class="action-buttons-container">
                <button class="button is-warning" onclick="addEyeDropTaperLine()">Add Taper</button>
                <button class="button is-primary" onclick="calculateEyeDropTaper()">Calculate</button>
                <button class="button is-secondary" onclick="copyEyeDropLabel()">Copy Label</button>
            </div>

            <div id="eyeDropLabel"></div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" onclick="closeHelpModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2>How to Use</h2>
                <button class="modal-close" onclick="closeHelpModal()">&times;</button>
            </div>
            <div class="modal-body">
                <h3>Tablet Taper</h3>
                <p>Create tapering schedules for steroid tablets. Select your medication, set the taper parameters, and click Calculate.</p>

                <h3>Prednisolone</h3>
                <p>Available strengths: 1mg, 5mg tablets. Once daily dosing only.</p>
                <ul>
                    <li><strong>Dose:</strong> Starting dose in mg (e.g., 30mg)</li>
                    <li><strong>Taper Amount:</strong> Reduce dose by this amount each step (e.g., 5mg)</li>
                    <li><strong>Interval:</strong> Days at each dose level (e.g., 7 days)</li>
                </ul>
                <p><strong>Example:</strong> Dose: 30mg, Taper: 5mg, Interval: 7 days</p>
                <p>Output: 30mg for 7 days, then 25mg for 7 days, then 20mg for 7 days, etc.</p>

                <h3>Dexamethasone</h3>
                <p>Available strengths: 0.5mg, 2mg, 4mg tablets. Supports OD (once daily) or BD (twice daily) dosing.</p>
                <ul>
                    <li><strong>Dose:</strong> Per-dose amount in mg (e.g., 4mg)</li>
                    <li><strong>Frequency:</strong> OD (once daily) or BD (twice daily)</li>
                    <li><strong>Taper Amount:</strong> Reduce <em>total daily dose</em> by this amount each step</li>
                    <li><strong>Interval:</strong> Days at each dose level</li>
                </ul>
                <p><strong>Example:</strong> 4mg BD, Taper: 4mg, Interval: 7 days, then add line for 2mg OD</p>
                <p>Output: 4mg BD (8mg daily) for 7 days, then 2mg BD (4mg daily) for 7 days, then 2mg OD for 7 days</p>
                <p><strong>Note:</strong> Use "Add Taper" to change frequency mid-taper (e.g., BD to OD).</p>

                <h3>General Options</h3>
                <ul>
                    <li><strong>Tablet Strengths:</strong> Deselect strengths that are out of stock.</li>
                    <li><strong>Start Date:</strong> Optional. Shows specific date ranges instead of "for X days".</li>
                    <li><strong>Add Taper:</strong> Add another line with different settings (slower taper, frequency change, etc.)</li>
                </ul>

                <h3>Copy Options</h3>
                <ul>
                    <li><strong>Copy Label:</strong> Copies just the dosing instructions.</li>
                    <li><strong>Document Copy:</strong> Copies instructions with steroid warning card info.</li>
                </ul>
                <p><strong>Warning:</strong> If a dose cannot be made exactly with the selected tablet strengths, a warning will be shown in red.</p>

                <hr style="margin: 20px 0; border: none; border-top: 1px solid #ddd;">

                <h3>Eye Drop Taper</h3>
                <p>Create post-operative eye drop tapering schedules.</p>
                <ul>
                    <li><strong>Select Eye(s):</strong> Left, Right, or Both eyes.</li>
                    <li><strong>Drop(s):</strong> Number of drops per dose.</li>
                    <li><strong>Frequency / Day:</strong> Times per day to apply drops.</li>
                    <li><strong>Taper Interval:</strong> Days at each frequency before reducing.</li>
                </ul>
                <p><strong>Example:</strong> 1 drop, Frequency: 4, Interval: 7 days</p>
                <p>Output: 1 drop FOUR times a day for 7 days, then THREE times a day for 7 days, etc.</p>
                <p><strong>Note:</strong> Total mls are estimated automatically. "Both" eyes doubles the total.</p>
            </div>
        </div>
    </div>

    <div id="notification" class="notification" style="display: none;">
        <span>Text copied to clipboard!</span>
        <button class="close-btn" onclick="hideNotification()">&times;</button>
    </div>

    <script>
        // ==================== STATE ====================
        let tabletTaperLines = [{ dose: 0, taperAmount: 0, interval: 0, frequency: 1 }];
        let eyeDropTaperLines = [{ dropCount: 0, frequency: 0, interval: 0 }];
        let selectedEye = 'Left';
        let tabletTextToCopy = '';
        let eyeDropTextToCopy = '';

        // Medication configurations
        const medicationConfig = {
            prednisolone: {
                name: 'Prednisolone',
                strengths: [5, 1], // ordered from highest to lowest
                defaultEnabled: [5, 1],
                supportedFrequencies: [1],
                defaultFrequency: 1
            },
            dexamethasone: {
                name: 'Dexamethasone',
                strengths: [4, 2, 0.5],
                defaultEnabled: [4, 2, 0.5],
                supportedFrequencies: [1, 2],
                defaultFrequency: 1
            }
        };
        let selectedMedication = 'prednisolone';
        let enabledStrengths = [...medicationConfig.prednisolone.defaultEnabled];

        // ==================== UTILITY FUNCTIONS ====================
        function numberToWords(num) {
            const ones = ['', 'ONE', 'TWO', 'THREE', 'FOUR', 'FIVE', 'SIX', 'SEVEN', 'EIGHT', 'NINE'];
            const teens = ['TEN', 'ELEVEN', 'TWELVE', 'THIRTEEN', 'FOURTEEN', 'FIFTEEN', 'SIXTEEN', 'SEVENTEEN', 'EIGHTEEN', 'NINETEEN'];
            const tens = ['', '', 'TWENTY', 'THIRTY', 'FORTY', 'FIFTY', 'SIXTY', 'SEVENTY', 'EIGHTY', 'NINETY'];

            if (num < 10) {
                return ones[num];
            } else if (num < 20) {
                return teens[num - 10];
            } else if (num < 100) {
                return tens[Math.floor(num / 10)] + (num % 10 === 0 ? '' : ' ' + ones[num % 10]);
            } else {
                return ones[Math.floor(num / 100)] + ' hundred' + (num % 100 === 0 ? '' : ' and ' + numberToWords(num % 100));
            }
        }

        function frequencyToWords(num) {
            const map = {
                1: 'ONCE a day',
                2: 'TWICE a day',
                3: 'THREE times a day',
                4: 'FOUR times a day',
                6: 'SIX times a day',
                8: 'every TWO hours',
                16: 'every HOUR'
            };
            return map[num] || num + ' times a day';
        }

        function showNotification() {
            const notification = document.getElementById('notification');
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function hideNotification() {
            document.getElementById('notification').style.display = 'none';
        }

        function openHelpModal() {
            document.getElementById('helpModal').classList.add('active');
        }

        function closeHelpModal(event) {
            if (!event || event.target === document.getElementById('helpModal')) {
                document.getElementById('helpModal').classList.remove('active');
            }
        }

        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showNotification();
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy to clipboard');
            }
        }

        // ==================== MEDICATION FUNCTIONS ====================
        function changeMedication() {
            selectedMedication = document.getElementById('medication-selector').value;
            const config = medicationConfig[selectedMedication];
            enabledStrengths = [...config.defaultEnabled];
            renderTabletStrengths();
            renderTabletTaperLines(); // Re-render to show/hide frequency dropdowns
        }

        function renderTabletStrengths() {
            const container = document.getElementById('tablet-strengths');
            const config = medicationConfig[selectedMedication];

            container.innerHTML = config.strengths.map(strength => {
                const isChecked = enabledStrengths.includes(strength);
                const strengthLabel = strength < 1 ? `${strength}mg` : `${strength}mg`;
                return `
                    <label class="checkbox-label ${isChecked ? 'checked' : ''}">
                        <input type="checkbox"
                               value="${strength}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleStrength(${strength}, this)">
                        ${strengthLabel}
                    </label>
                `;
            }).join('');
        }

        function toggleStrength(strength, checkbox) {
            const label = checkbox.parentElement;
            if (checkbox.checked) {
                if (!enabledStrengths.includes(strength)) {
                    enabledStrengths.push(strength);
                    enabledStrengths.sort((a, b) => b - a); // Sort descending
                }
                label.classList.add('checked');
            } else {
                enabledStrengths = enabledStrengths.filter(s => s !== strength);
                label.classList.remove('checked');
            }
        }

        // Calculate tablets needed for a dose using available strengths
        function calculateTabletsForDose(dose, strengths) {
            const result = [];
            let remaining = dose;

            // Sort strengths from highest to lowest
            const sortedStrengths = [...strengths].sort((a, b) => b - a);

            for (const strength of sortedStrengths) {
                if (remaining >= strength) {
                    const count = Math.floor(remaining / strength);
                    if (count > 0) {
                        result.push({ strength, count });
                        remaining = Math.round((remaining - (count * strength)) * 100) / 100; // Handle floating point
                    }
                }
            }

            // Check if we couldn't make exact dose
            if (remaining > 0.001) {
                return { tablets: result, remainder: remaining, exact: false };
            }

            return { tablets: result, remainder: 0, exact: true };
        }

        // ==================== TAPER TYPE SWITCHING ====================
        function switchTaperType() {
            const type = document.getElementById('taperType').value;
            document.getElementById('tabletTaper').classList.remove('active');
            document.getElementById('eyeDropTaper').classList.remove('active');

            if (type === 'tablet') {
                document.getElementById('tabletTaper').classList.add('active');
            } else {
                document.getElementById('eyeDropTaper').classList.add('active');
            }
        }

        // ==================== TABLET TAPER ====================
        function renderTabletTaperLines() {
            const container = document.getElementById('tabletTaperLines');
            const config = medicationConfig[selectedMedication];
            const showFrequency = config.supportedFrequencies.length > 1;

            container.innerHTML = tabletTaperLines.map((line, index) => `
                <div class="taper-input-row">
                    <div class="field">
                        <label class="label">Dose (mg)</label>
                        <input class="input" type="number" min="0" step="1"
                               value="${line.dose}"
                               onchange="updateTabletLine(${index}, 'dose', this.value)"
                               placeholder="Enter Dose">
                    </div>
                    ${showFrequency ? `
                    <div class="field">
                        <label class="label">Frequency</label>
                        <select class="input" onchange="updateTabletLine(${index}, 'frequency', this.value)">
                            <option value="1" ${line.frequency === 1 ? 'selected' : ''}>OD</option>
                            <option value="2" ${line.frequency === 2 ? 'selected' : ''}>BD</option>
                        </select>
                    </div>
                    ` : ''}
                    <div class="field">
                        <label class="label">Taper Amount</label>
                        <input class="input" type="number" min="0" step="1"
                               value="${line.taperAmount}"
                               onchange="updateTabletLine(${index}, 'taperAmount', this.value)"
                               placeholder="Enter Taper Amount">
                    </div>
                    <div class="field">
                        <label class="label">Interval (days)</label>
                        <input class="input" type="number" min="0" step="1"
                               value="${line.interval}"
                               onchange="updateTabletLine(${index}, 'interval', this.value)"
                               placeholder="Enter Interval">
                    </div>
                    <div class="field delete-button-container">
                        <button class="button is-danger" onclick="deleteTabletLine(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addTabletTaperLine() {
            tabletTaperLines.push({ dose: 0, taperAmount: 0, interval: 0, frequency: 1 });
            renderTabletTaperLines();
        }

        function deleteTabletLine(index) {
            tabletTaperLines.splice(index, 1);
            if (tabletTaperLines.length === 0) {
                tabletTaperLines = [{ dose: 0, taperAmount: 0, interval: 0, frequency: 1 }];
            }
            renderTabletTaperLines();
        }

        function updateTabletLine(index, field, value) {
            tabletTaperLines[index][field] = Math.max(0, Math.floor(Number(value))) || 0;
        }

        function calculateTabletTaper() {
            const taperLabel = document.getElementById('taperLabel');
            taperLabel.innerHTML = '';

            // Check if any strengths are selected
            if (enabledStrengths.length === 0) {
                taperLabel.innerHTML = '<p style="color: #e74c3c;"><strong>Please select at least one tablet strength.</strong></p>';
                return;
            }

            const config = medicationConfig[selectedMedication];
            let textToCopy = `${config.name} Taper:\n`;

            const startDateInput = document.getElementById('tablet-date-selector');
            let startDate = startDateInput && startDateInput.value ? new Date(startDateInput.value) : null;

            // Track totals for each strength
            const tabletTotals = {};
            enabledStrengths.forEach(s => tabletTotals[s] = 0);

            let hasWarnings = false;

            // Add medication header
            const headerParagraph = document.createElement('p');
            headerParagraph.innerHTML = `<strong>${config.name} Taper</strong>`;
            taperLabel.appendChild(headerParagraph);

            // Work in terms of total daily dose
            const firstFreq = tabletTaperLines[0].frequency || 1;
            let currentDailyDose = tabletTaperLines[0].dose * firstFreq;

            for (let i = 0; i < tabletTaperLines.length; i++) {
                const lineFrequency = tabletTaperLines[i].frequency || 1;
                const nextDose = i < tabletTaperLines.length - 1 ? tabletTaperLines[i + 1].dose : 0;
                const nextFrequency = i < tabletTaperLines.length - 1 ? (tabletTaperLines[i + 1].frequency || 1) : 1;
                const nextDailyDose = nextDose * nextFrequency;

                // Compare total daily doses to determine when to stop tapering
                while (currentDailyDose > nextDailyDose) {
                    // Calculate per-dose amount from daily dose
                    const perDose = currentDailyDose / lineFrequency;
                    const calculation = calculateTabletsForDose(perDose, enabledStrengths);

                    let text = 'Take ';
                    const tabletParts = [];

                    calculation.tablets.forEach(({ strength, count }) => {
                        const strengthLabel = strength < 1 ? `${strength}mg` : `${strength}mg`;
                        tabletParts.push(`${numberToWords(count)} ${strengthLabel} tablet${count > 1 ? 's' : ''}`);

                        // Add to totals (multiply by frequency for twice daily)
                        tabletTotals[strength] += count * tabletTaperLines[i].interval * lineFrequency;
                    });

                    if (tabletParts.length === 0) {
                        text = `Cannot make ${perDose}mg dose with selected tablets`;
                        hasWarnings = true;
                    } else {
                        text += tabletParts.join(' and ');
                        if (lineFrequency === 2) {
                            text += ` TWICE a day (${currentDailyDose}mg daily)`;
                        } else {
                            text += ` (a ${perDose}mg dose)`;
                        }

                        if (!calculation.exact) {
                            text += ` [WARNING: ${calculation.remainder}mg short]`;
                            hasWarnings = true;
                        }
                    }

                    if (startDate) {
                        const endDate = new Date(startDate.getTime() + (tabletTaperLines[i].interval - 1) * 24 * 60 * 60 * 1000);
                        text += ` from ${startDate.toLocaleDateString()} to ${endDate.toLocaleDateString()}`;
                        startDate = new Date(endDate.getTime() + 24 * 60 * 60 * 1000);
                    } else {
                        text += ` for ${tabletTaperLines[i].interval} days`;
                    }

                    const paragraph = document.createElement('p');
                    paragraph.textContent = text;
                    if (!calculation.exact || calculation.tablets.length === 0) {
                        paragraph.style.color = '#e74c3c';
                    }
                    taperLabel.appendChild(paragraph);
                    textToCopy += text + '\n';

                    // Taper by reducing daily dose
                    currentDailyDose = Math.max(nextDailyDose, currentDailyDose - tabletTaperLines[i].taperAmount);
                }
            }

            // Build totals summary
            const totalParagraph = document.createElement('p');
            totalParagraph.className = 'subtitle';

            const totalParts = [];
            enabledStrengths.sort((a, b) => b - a).forEach(strength => {
                if (tabletTotals[strength] > 0) {
                    const strengthLabel = strength < 1 ? `${strength}mg` : `${strength}mg`;
                    totalParts.push(`<strong>${tabletTotals[strength]}</strong> x ${strengthLabel} tablets`);
                }
            });

            totalParagraph.innerHTML = `<strong>Total tablets required:</strong><br>${totalParts.join(' & ')}`;
            taperLabel.appendChild(totalParagraph);

            if (hasWarnings) {
                const warningParagraph = document.createElement('p');
                warningParagraph.style.color = '#e74c3c';
                warningParagraph.innerHTML = '<strong>Warning:</strong> Some doses could not be made exactly with the selected tablet strengths.';
                taperLabel.appendChild(warningParagraph);
            }

            tabletTextToCopy = textToCopy;
        }

        function copyTabletLabel() {
            if (tabletTextToCopy) {
                copyToClipboard(tabletTextToCopy);
            }
        }

        function copyTabletDocument() {
            const patientInfo1 = `ALERT: I TAKE STEROID MEDICATION
I am at risk of adrenal crisis

IN CASE OF EMERGENCY:

I need immediate hydrocortisone
Call 999 or take me to A&E
Show this card to the medical staff

IMPORTANT:

I must not stop taking steroids suddenly
I need extra steroids during illness or injury
I should carry extra medication at all times`;

            const patientInfo2 = `--- Additional Information ---
- Take your medication as prescribed with food.
- Never stop taking steroids suddenly.
- Report any new symptoms or side effects to your healthcare provider promptly.
- Attend regular check-ups and blood tests as recommended by your doctor.

--- End of Document ---`;

            if (tabletTextToCopy) {
                copyToClipboard(patientInfo1 + '\n\n' + tabletTextToCopy + '\n' + patientInfo2);
            }
        }

        // ==================== EYE DROP TAPER ====================
        function renderEyeDropTaperLines() {
            const container = document.getElementById('eyeDropTaperLines');
            container.innerHTML = eyeDropTaperLines.map((line, index) => `
                <div class="taper-input-row">
                    <div class="field">
                        <label class="label">Drop(s)</label>
                        <input class="input" type="number" min="0" step="1"
                               value="${line.dropCount}"
                               onchange="updateEyeDropLine(${index}, 'dropCount', this.value)"
                               placeholder="Enter Drops">
                    </div>
                    <div class="field">
                        <label class="label">Frequency / Day</label>
                        <select class="input" onchange="updateEyeDropLine(${index}, 'frequency', this.value)">
                            <option value="0" ${line.frequency === 0 ? 'selected' : ''}>Select Frequency</option>
                            <option value="16" ${line.frequency === 16 ? 'selected' : ''}>16</option>
                            <option value="8" ${line.frequency === 8 ? 'selected' : ''}>8</option>
                            <option value="6" ${line.frequency === 6 ? 'selected' : ''}>6</option>
                            <option value="4" ${line.frequency === 4 ? 'selected' : ''}>4</option>
                            <option value="3" ${line.frequency === 3 ? 'selected' : ''}>3</option>
                            <option value="2" ${line.frequency === 2 ? 'selected' : ''}>2</option>
                            <option value="1" ${line.frequency === 1 ? 'selected' : ''}>1</option>
                        </select>
                    </div>
                    <div class="field">
                        <label class="label">Taper Interval</label>
                        <input class="input" type="number" min="0" step="1"
                               value="${line.interval}"
                               onchange="updateEyeDropLine(${index}, 'interval', this.value)"
                               placeholder="Enter Interval">
                    </div>
                    <div class="field delete-button-container">
                        <button class="button is-danger" onclick="deleteEyeDropLine(${index})">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        function addEyeDropTaperLine() {
            eyeDropTaperLines.push({ dropCount: 0, frequency: 0, interval: 0 });
            renderEyeDropTaperLines();
        }

        function deleteEyeDropLine(index) {
            eyeDropTaperLines.splice(index, 1);
            if (eyeDropTaperLines.length === 0) {
                eyeDropTaperLines = [{ dropCount: 0, frequency: 0, interval: 0 }];
            }
            renderEyeDropTaperLines();
        }

        function updateEyeDropLine(index, field, value) {
            eyeDropTaperLines[index][field] = Math.max(0, Math.floor(Number(value))) || 0;
        }

        function selectEye(eye, button) {
            selectedEye = eye;
            document.querySelectorAll('.eye-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
        }

        function calculateEyeDropTaper() {
            const eyeDropLabel = document.getElementById('eyeDropLabel');
            eyeDropLabel.innerHTML = '';

            const results = [];
            let totalDropCount = 0;
            const normalFrequency = [16, 8, 6, 4, 3, 2, 1];
            let copyText = `[Apply to ${selectedEye.toUpperCase()} eye(s)]\n`;

            for (let lineIndex = 0; lineIndex < eyeDropTaperLines.length; lineIndex++) {
                const currentLine = eyeDropTaperLines[lineIndex];
                const nextLine = lineIndex < eyeDropTaperLines.length - 1 ? eyeDropTaperLines[lineIndex + 1] : null;

                if (currentLine.frequency === 0) continue;

                const startIndex = normalFrequency.indexOf(currentLine.frequency);
                if (startIndex === -1) continue;

                let endIndex = nextLine ? normalFrequency.indexOf(nextLine.frequency) : normalFrequency.length;
                if (endIndex === -1) endIndex = normalFrequency.length;

                for (let i = startIndex; i < endIndex; i++) {
                    const currentFreq = normalFrequency[i];
                    const text = `Apply ${currentLine.dropCount} drop${currentLine.dropCount > 1 ? 's' : ''} ${frequencyToWords(currentFreq)} for ${currentLine.interval} days`;
                    results.push(text);
                    copyText += text + '\n';
                    totalDropCount += currentLine.dropCount * currentFreq * currentLine.interval;
                }

                if (nextLine && currentLine.frequency === nextLine.frequency) {
                    const text = `Apply ${currentLine.dropCount} drop${currentLine.dropCount > 1 ? 's' : ''} ${frequencyToWords(currentLine.frequency)} for ${currentLine.interval} days`;
                    results.push(text);
                    copyText += text + '\n';
                    totalDropCount += currentLine.dropCount * currentLine.frequency * currentLine.interval;
                    continue;
                }

                if (nextLine && endIndex < normalFrequency.length) {
                    for (let i = endIndex; i < normalFrequency.length; i++) {
                        const currentFreq = normalFrequency[i];
                        const text = `Apply ${nextLine.dropCount} drop${nextLine.dropCount > 1 ? 's' : ''} ${frequencyToWords(currentFreq)} for ${nextLine.interval} days`;
                        results.push(text);
                        copyText += text + '\n';
                        totalDropCount += nextLine.dropCount * currentFreq * nextLine.interval;
                    }
                    break;
                }
            }

            // Double the amount if both eyes selected
            const eyeMultiplier = selectedEye === 'Both' ? 2 : 1;
            const totalMls = (totalDropCount * eyeMultiplier) / 20;

            // Display results
            if (results.length > 0) {
                const eyeHeader = document.createElement('p');
                eyeHeader.innerHTML = `<strong>Apply to ${selectedEye.toUpperCase()} EYE</strong>`;
                eyeDropLabel.appendChild(eyeHeader);
            }

            results.forEach(result => {
                const p = document.createElement('p');
                p.textContent = result;
                eyeDropLabel.appendChild(p);
            });

            if (totalMls > 0) {
                const totalParagraph = document.createElement('p');
                totalParagraph.className = 'subtitle';
                totalParagraph.innerHTML = `<strong>Total mls needed:</strong><br><strong>${totalMls.toFixed(1)}</strong>`;
                eyeDropLabel.appendChild(totalParagraph);
            }

            eyeDropTextToCopy = copyText;
        }

        function copyEyeDropLabel() {
            if (eyeDropTextToCopy) {
                copyToClipboard(eyeDropTextToCopy);
            }
        }

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            renderTabletStrengths();
            renderTabletTaperLines();
            renderEyeDropTaperLines();
        });
    </script>
</body>
</html>
